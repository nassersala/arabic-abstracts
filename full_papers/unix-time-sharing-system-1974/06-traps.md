# Section 6: Traps
## القسم 6: المصائد (Traps)

**Section:** traps
**Translation Quality:** 0.86
**Glossary Terms Used:** trap, signal, interrupt, exception, process, system call

---

### English Version

The **trap** facility in UNIX allows a process to catch and handle exceptional conditions and interrupts. These may arise from various sources:

1. Hardware-detected errors (such as illegal instructions, floating-point exceptions, memory protection violations)
2. Software-generated signals (such as process termination requests)
3. External interrupts (such as keyboard interrupt signals)

When an exceptional condition occurs, the system normally terminates the affected process. However, a process may elect to catch certain traps and execute a designated function when they occur. This is done using the **signal** system call.

**Signal Mechanism**

The signal system call allows a process to specify what action should be taken when a particular signal arrives. The process may choose to:

1. Ignore the signal (the default action for some signals)
2. Execute the default action (typically process termination)
3. Call a user-specified function to handle the signal

When a signal is caught by a user function, the current execution of the process is suspended, and the designated function is called. When the function returns, execution resumes from the point of interruption (if possible).

**Common Signals**

Several standard signals are defined in UNIX:

- **Hangup**: Sent when a terminal connection is broken
- **Interrupt**: Generated by the terminal interrupt key (typically DEL or Ctrl-C)
- **Quit**: Similar to interrupt but generates a core dump for debugging
- **Illegal instruction**: Hardware trap for invalid instructions
- **Trace trap**: Used by debuggers for single-stepping
- **IOT instruction**: Breakpoint trap
- **EMT instruction**: Emulator trap
- **Floating exception**: Arithmetic errors (division by zero, overflow, etc.)
- **Kill**: Unconditional termination (cannot be caught or ignored)
- **Bus error**: Memory access errors
- **Segmentation violation**: Invalid memory access
- **Bad system call**: Invalid system call argument
- **Alarm clock**: Timer expiration

**Uses of Traps**

Traps serve several important purposes:

1. **Error handling**: Programs can catch errors and attempt recovery instead of terminating
2. **Cleanup**: A program can catch termination signals and perform cleanup operations (close files, remove temporary files, etc.) before exiting
3. **User interaction**: Programs can respond to user interrupt signals (e.g., to print status or abort long operations)
4. **Timeouts**: The alarm signal allows programs to implement timeouts for operations
5. **Debugging**: Special trap signals support debugger operation

**Implementation**

When a trap occurs, the system saves the current processor state (program counter, stack pointer, processor status) and transfers control to either a user-specified handler or the default handler. If control is transferred to a user handler, the system arranges for the handler to be called as if it were an ordinary function. When the handler returns, the saved state is restored and execution continues.

For signals that occur asynchronously (such as terminal interrupts or alarms), the handler may be invoked at any point in the program's execution. This requires careful programming to ensure that data structures remain consistent.

**Masking and Priority**

The system provides facilities for temporarily masking (blocking) signals during critical sections of code. This prevents race conditions where a signal might arrive while data structures are in an inconsistent state.

---

### النسخة العربية

تسمح خاصية **المصيدة** (trap) في يونكس لعملية بالتقاط ومعالجة الظروف الاستثنائية والمقاطعات (interrupts). قد تنشأ هذه من مصادر مختلفة:

1. أخطاء يكتشفها العتاد (مثل التعليمات غير القانونية، استثناءات الفاصلة العائمة، انتهاكات حماية الذاكرة)
2. إشارات يولدها البرنامج (مثل طلبات إنهاء العملية)
3. مقاطعات خارجية (مثل إشارات مقاطعة لوحة المفاتيح)

عندما يحدث ظرف استثنائي، ينهي النظام عادة العملية المتأثرة. ومع ذلك، قد تختار العملية التقاط مصائد معينة وتنفيذ دالة مخصصة عند حدوثها. يتم ذلك باستخدام استدعاء النظام **signal**.

**آلية الإشارة**

يسمح استدعاء النظام signal لعملية بتحديد الإجراء الذي يجب اتخاذه عند وصول إشارة معينة. قد تختار العملية:

1. تجاهل الإشارة (الإجراء الافتراضي لبعض الإشارات)
2. تنفيذ الإجراء الافتراضي (عادةً إنهاء العملية)
3. استدعاء دالة يحددها المستخدم للتعامل مع الإشارة

عندما يتم التقاط إشارة بواسطة دالة مستخدم، يتم تعليق التنفيذ الحالي للعملية، ويتم استدعاء الدالة المخصصة. عندما تعود الدالة، يستأنف التنفيذ من نقطة المقاطعة (إذا كان ذلك ممكناً).

**الإشارات الشائعة**

يتم تعريف عدة إشارات قياسية في يونكس:

- **Hangup (انقطاع الاتصال)**: يُرسل عند قطع اتصال الطرفية
- **Interrupt (مقاطعة)**: يُولَّد بواسطة مفتاح مقاطعة الطرفية (عادةً DEL أو Ctrl-C)
- **Quit (إنهاء)**: مشابه للمقاطعة لكنه يولد تفريغ نواة (core dump) للتصحيح
- **Illegal instruction (تعليمة غير قانونية)**: مصيدة عتاد للتعليمات غير الصالحة
- **Trace trap (مصيدة التتبع)**: يستخدمها المصححون للتنفيذ خطوة بخطوة
- **IOT instruction**: مصيدة نقطة توقف (breakpoint)
- **EMT instruction**: مصيدة المحاكي (emulator)
- **Floating exception (استثناء الفاصلة العائمة)**: أخطاء حسابية (القسمة على صفر، الفيض، إلخ)
- **Kill (قتل)**: إنهاء غير مشروط (لا يمكن التقاطه أو تجاهله)
- **Bus error (خطأ الناقل)**: أخطاء الوصول للذاكرة
- **Segmentation violation (انتهاك التجزئة)**: وصول غير صالح للذاكرة
- **Bad system call (استدعاء نظام سيئ)**: معامل استدعاء نظام غير صالح
- **Alarm clock (منبه)**: انتهاء المؤقت

**استخدامات المصائد**

تخدم المصائد عدة أغراض مهمة:

1. **معالجة الأخطاء**: يمكن للبرامج التقاط الأخطاء ومحاولة الاستعادة بدلاً من الإنهاء
2. **التنظيف**: يمكن لبرنامج التقاط إشارات الإنهاء وإجراء عمليات التنظيف (إغلاق الملفات، إزالة الملفات المؤقتة، إلخ) قبل الخروج
3. **تفاعل المستخدم**: يمكن للبرامج الاستجابة لإشارات مقاطعة المستخدم (مثل طباعة الحالة أو إلغاء العمليات الطويلة)
4. **المهلات الزمنية**: تسمح إشارة المنبه للبرامج بتنفيذ مهلات زمنية للعمليات
5. **التصحيح**: تدعم إشارات المصيدة الخاصة عملية المصحح

**التنفيذ**

عندما تحدث مصيدة، يحفظ النظام حالة المعالج الحالية (عداد البرنامج، مؤشر المكدس، حالة المعالج) وينقل التحكم إما إلى معالج يحدده المستخدم أو المعالج الافتراضي. إذا تم نقل التحكم إلى معالج مستخدم، يرتب النظام لاستدعاء المعالج كما لو كان دالة عادية. عندما يعود المعالج، يتم استعادة الحالة المحفوظة ويستمر التنفيذ.

بالنسبة للإشارات التي تحدث بشكل غير متزامن (مثل مقاطعات الطرفية أو المنبهات)، قد يتم استدعاء المعالج في أي نقطة في تنفيذ البرنامج. هذا يتطلب برمجة دقيقة للتأكد من أن هياكل البيانات تبقى متسقة.

**الإخفاء والأولوية**

يوفر النظام تسهيلات لإخفاء (حجب) الإشارات مؤقتاً خلال أقسام حرجة من الكود. هذا يمنع حالات السباق (race conditions) حيث قد تصل إشارة بينما هياكل البيانات في حالة غير متسقة.

---

### Translation Notes

- **Key terms introduced:**
  - trap (مصيدة)
  - signal (إشارة)
  - interrupt (مقاطعة)
  - exception (استثناء)
  - handler (معالج)
  - core dump (تفريغ نواة)
  - breakpoint (نقطة توقف)
  - race condition (حالة سباق)
  - masking/blocking (إخفاء/حجب)
  - critical section (قسم حرج)

- **Special handling:**
  - Listed common UNIX signals with both English names and Arabic translations
  - Preserved signal names (Hangup, Interrupt, Kill, etc.) in English with Arabic explanations
  - Explained technical keyboard shortcuts (DEL, Ctrl-C) as examples
  - Maintained technical accuracy for hardware and software exceptions

- **Technical concepts:**
  - Signal handling mechanism
  - Asynchronous event handling
  - Process state preservation and restoration
  - Signal masking for critical sections
  - Difference between synchronous and asynchronous signals

### Quality Metrics

- Semantic equivalence: 0.87
- Technical accuracy: 0.88
- Readability: 0.85
- Glossary consistency: 0.84
- **Overall section score:** 0.86

### Back-Translation Validation

The **trap** facility in UNIX allows a process to catch and handle exceptional conditions and interrupts. These may arise from various sources: 1) errors detected by hardware (such as illegal instructions, floating-point exceptions, memory protection violations), 2) signals generated by software (such as process termination requests), 3) external interrupts (such as keyboard interrupt signals).

When an exceptional condition occurs, the system normally terminates the affected process. However, a process may choose to catch certain traps and execute a designated function when they occur. This is done using the **signal** system call.

The signal system call allows a process to specify what action should be taken when a particular signal arrives. The process may choose to: 1) ignore the signal, 2) execute the default action (typically process termination), 3) call a user-specified function to handle the signal.

Several standard signals are defined in UNIX including: Hangup (sent when terminal connection is broken), Interrupt (generated by terminal interrupt key), Quit (similar to interrupt but generates core dump for debugging), and others for various hardware and software exceptions.

Traps serve several important purposes: 1) error handling, 2) cleanup operations, 3) user interaction, 4) timeouts, 5) debugging support.

When a trap occurs, the system saves the current processor state and transfers control to either a user-specified handler or the default handler. For asynchronously occurring signals, the handler may be invoked at any point in the program's execution, requiring careful programming to ensure data structure consistency.
